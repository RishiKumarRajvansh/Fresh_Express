{% extends 'base_mobile.html' %}

{% block title %}
{% if is_order_support %}
Support for Order #{{ order.order_number }}
{% else %}
Customer Support
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 70vh;
        display: flex;
        flex-direction: column;
        border: 1px solid #ddd;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        padding: 15px 20px;
        border-bottom: 1px solid #ddd;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
    }
    
    .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
    }
    
    .message.sent {
        justify-content: flex-end;
    }
    
    .message.received {
        justify-content: flex-start;
    }
    
    .message.system {
        justify-content: center;
    }
    
    .message-content {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 15px;
        position: relative;
    }
    
    .message.sent .message-content {
        background: #007bff;
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .message.received .message-content {
        background: white;
        border: 1px solid #ddd;
        border-bottom-left-radius: 5px;
    }
    
    .message.system .message-content {
        background: #e9ecef;
        color: #6c757d;
        font-style: italic;
        text-align: center;
        border-radius: 20px;
        max-width: 90%;
        font-size: 0.85em;
    }
    
    .message-time {
        font-size: 0.75em;
        opacity: 0.7;
        margin-top: 5px;
    }
    
    .chat-input {
        border-top: 1px solid #ddd;
        padding: 15px 20px;
        background: white;
    }
    
    .message-sender {
        font-weight: bold;
        font-size: 0.8em;
        margin-bottom: 3px;
    }
    
    .order-info-card {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .quick-actions {
        margin-bottom: 15px;
    }
    
    .quick-action-btn {
        margin: 2px;
        font-size: 0.85em;
    }
    
    #messageInput {
        border-radius: 25px;
        border: 1px solid #ddd;
        padding: 12px 20px;
    }
    
    #sendButton {
        border-radius: 50%;
        width: 45px;
        height: 45px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .typing-indicator {
        padding: 10px 15px;
        background: #e9ecef;
        border-radius: 15px;
        margin: 10px 0;
        font-style: italic;
        color: #6c757d;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            
            <!-- Order Information Card (if order support) -->
            {% if is_order_support and order %}
            <div class="order-info-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="mb-1"><i class="fas fa-shopping-cart me-2"></i>Order #{{ order.order_number }}</h5>
                        <p class="mb-1">{{ order.store.name }}</p>
                        <small>Placed: {{ order.created_at|date:"M d, Y g:i A" }}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-light text-dark fs-6">{{ order.get_status_display }}</span>
                        <div class="mt-1">
                            <small>â‚¹{{ order.total_amount }}</small>
                        </div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <h6 class="mb-2">Quick Actions:</h6>
                    <button class="btn btn-outline-light btn-sm quick-action-btn" onclick="sendQuickMessage('Where is my order?')">
                        <i class="fas fa-map-marker-alt me-1"></i>Track Order
                    </button>
                    <button class="btn btn-outline-light btn-sm quick-action-btn" onclick="sendQuickMessage('I want to modify my order')">
                        <i class="fas fa-edit me-1"></i>Modify Order
                    </button>
                    <button class="btn btn-outline-light btn-sm quick-action-btn" onclick="sendQuickMessage('I have an issue with my order')">
                        <i class="fas fa-exclamation-triangle me-1"></i>Report Issue
                    </button>
                    <button class="btn btn-outline-light btn-sm quick-action-btn" onclick="sendQuickMessage('I need a refund')">
                        <i class="fas fa-money-bill-wave me-1"></i>Refund Request
                    </button>
                </div>
            </div>
            {% endif %}
            
            <!-- Chat Container -->
            <div class="chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">
                                {% if is_order_support %}
                                <i class="fas fa-headset me-2"></i>Order Support
                                {% else %}
                                <i class="fas fa-comments me-2"></i>Customer Support
                                {% endif %}
                            </h6>
                            <small>
                                {% if is_order_support and order %}
                                {{ order.store.name }} Support Team
                                {% else %}
                                General Support Team
                                {% endif %}
                                - <span class="badge bg-success">Online</span>
                            </small>
                        </div>
                        <div>
                            <button class="btn btn-outline-light btn-sm" onclick="refreshChat()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div class="chat-messages" id="chatMessages">
                    {% for message in messages %}
                    <div class="message {% if message.sender == user %}sent{% elif message.sender %}received{% else %}system{% endif %}">
                        <div class="message-content">
                            {% if message.sender and message.sender != user %}
                            <div class="message-sender">
                                {% if message.sender.first_name %}
                                {{ message.sender.first_name }} 
                                {% if is_order_support %}({{ order.store.name }}){% endif %}
                                {% else %}
                                Support Team
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <div>{{ message.content|linebreaks }}</div>
                            
                            <div class="message-time">
                                {{ message.created_at|date:"g:i A" }}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="message system">
                        <div class="message-content">
                            <i class="fas fa-comments me-2"></i>
                            {% if is_order_support %}
                            Start a conversation about your order. A store representative will respond soon.
                            {% else %}
                            Welcome to customer support! How can we help you today?
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Typing Indicator -->
                    <div class="typing-indicator" id="typingIndicator">
                        <i class="fas fa-ellipsis-h"></i> Support team is typing...
                    </div>
                </div>
                
                <!-- Message Input -->
                <div class="chat-input">
                    <form id="messageForm" class="d-flex align-items-center">
                        {% csrf_token %}
                        <input type="hidden" name="session_id" value="{{ chat_session.session_id }}">
                        <div class="flex-grow-1 me-3">
                            <input 
                                type="text" 
                                class="form-control" 
                                id="messageInput" 
                                name="message" 
                                placeholder="Type your message..." 
                                maxlength="1000"
                                required
                            >
                        </div>
                        <button type="submit" class="btn btn-primary" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            {% if is_order_support %}
                            Your message will be sent directly to {{ order.store.name }} support team
                            {% else %}
                            Our support team typically responds within a few minutes
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Additional Actions -->
            <div class="mt-3 text-center">
                <a href="{% if is_order_support %}{% url 'orders:order_detail' order.order_number %}{% else %}{% url 'core:home' %}{% endif %}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left me-1"></i>
                    {% if is_order_support %}Back to Order{% else %}Back to Home{% endif %}
                </a>
                
                {% if is_order_support %}
                <a href="{% url 'orders:order_tracking' order.order_number %}" class="btn btn-outline-info me-2">
                    <i class="fas fa-truck me-1"></i>Track Order
                </a>
                {% endif %}
                
                <button class="btn btn-outline-success" onclick="endChat()">
                    <i class="fas fa-check me-1"></i>End Chat
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Chat functionality
const chatMessages = document.getElementById('chatMessages');
const messageForm = document.getElementById('messageForm');
const messageInput = document.getElementById('messageInput');
const typingIndicator = document.getElementById('typingIndicator');

// Redirect URL to use when ending chat (resolved server-side)
const END_CHAT_REDIRECT = '{% if is_order_support %}{% url "orders:order_detail" order.order_number %}{% else %}{% url "core:home" %}{% endif %}';

// Auto-scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Initial scroll
scrollToBottom();

// Send message
messageForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Add message to chat immediately
    addMessageToChat('sent', message, 'You', new Date());
    
    // Clear input
    messageInput.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to server (implement AJAX here)
    sendMessageToServer(message);
});

// Quick message sending
function sendQuickMessage(message) {
    messageInput.value = message;
    messageForm.dispatchEvent(new Event('submit'));
}

// Add message to chat UI
function addMessageToChat(type, content, sender, timestamp) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    const timeStr = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
        <div class="message-content">
            ${type === 'received' ? `<div class="message-sender">${sender}</div>` : ''}
            <div>${content}</div>
            <div class="message-time">${timeStr}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

// Show typing indicator
function showTypingIndicator() {
    typingIndicator.style.display = 'block';
    scrollToBottom();
    
    // Hide after 3 seconds (simulate response)
    setTimeout(() => {
        typingIndicator.style.display = 'none';
        
        // Simulate support response
        const responses = [
            "Thank you for contacting us. Let me check on that for you.",
            "I'm looking into your order details right now.",
            "I understand your concern. Let me help you with that.",
            "Thank you for reaching out. I'll assist you with this issue."
        ];
        
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        addMessageToChat('received', randomResponse, 'Support Team', new Date());
    }, 2000 + Math.random() * 2000);
}

// Send message to server (implement proper AJAX)
function sendMessageToServer(message) {
    // TODO: Implement WebSocket or AJAX call to send message
    console.log('Sending message:', message);
}

// Refresh chat
function refreshChat() {
    window.location.reload();
}

// End chat
function endChat() {
    if (confirm('Are you sure you want to end this chat session?')) {
        // TODO: Implement chat ending logic
    // Redirect to appropriate page (server-side resolved)
    window.location.href = END_CHAT_REDIRECT;
    }
}

// Auto-refresh messages every 5 seconds
setInterval(function() {
    // TODO: Implement AJAX polling or WebSocket for real-time updates
}, 5000);
</script>
{% endblock %}
