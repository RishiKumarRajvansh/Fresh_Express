{% extends 'dashboards/base_dashboard.html' %}
{% load static %}

{% block header_actions %}
<button id="toggle-availability" class="btn btn-{% if agent.is_available %}danger{% else %}success{% endif %}">
    <i class="fas fa-power-off me-1"></i>
    {% if agent.is_available %}Go Offline{% else %}Go Online{% endif %}
</button>
<a href="{% url 'delivery:earnings' %}" class="btn btn-outline-light">
    <i class="fas fa-rupee-sign me-1"></i>Earnings
</a>
{% endblock %}

{% block dashboard_content %}
{% if agent %}
<div class="row">
    <!-- Agent Stats -->
    <div class="col-12">
        <div class="stats-grid">
            <div class="stat-card {% if agent.is_available %}border-success{% else %}border-danger{% endif %}">
                <div class="stat-header">
                    <div class="stat-icon" style="background: {% if agent.is_available %}var(--dashboard-success){% else %}var(--dashboard-danger){% endif %};">
                        <i class="fas fa-{% if agent.is_available %}check-circle{% else %}times-circle{% endif %}"></i>
                    </div>
                </div>
                <div class="stat-number">{% if agent.is_available %}Online{% else %}Offline{% endif %}</div>
                <div class="stat-label">Status</div>
                <div class="mt-2">
                    <small class="text-{% if agent.is_available %}success{% else %}danger{% endif %}">
                        {% if agent.is_available %}Available for deliveries{% else %}Not taking orders{% endif %}
                    </small>
                </div>
            </div>
            
            <div class="stat-card warning">
                <div class="stat-header">
                    <div class="stat-icon" style="background: var(--dashboard-warning);">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div class="stat-number">{{ agent_stats.pending_deliveries|default:0 }}</div>
                <div class="stat-label">Pending Deliveries</div>
                <div class="mt-2">
                    <small class="text-warning">Active assignments</small>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: var(--dashboard-info);">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                </div>
                <div class="stat-number">{{ agent_stats.today_deliveries|default:0 }}</div>
                <div class="stat-label">Today's Deliveries</div>
                <div class="mt-2">
                    <small class="text-muted">Completed today</small>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: var(--dashboard-success);">
                        <i class="fas fa-check"></i>
                    </div>
                </div>
                <div class="stat-number">{{ agent_stats.total_deliveries|default:0 }}</div>
                <div class="stat-label">Total Deliveries</div>
                <div class="mt-2">
                    <small class="text-muted">All time completed</small>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: var(--dashboard-primary);">
                        <i class="fas fa-rupee-sign"></i>
                    </div>
                </div>
                <div class="stat-number">₹{{ agent_stats.total_earnings|default:0 }}</div>
                <div class="stat-label">Total Earnings</div>
                <div class="mt-2">
                    <small class="text-muted">Estimated total</small>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: var(--dashboard-warning);">
                        <i class="fas fa-star"></i>
                    </div>
                </div>
                <div class="stat-number">{{ agent.rating|default:"N/A" }}</div>
                <div class="stat-label">Rating</div>
                <div class="mt-2">
                    <small class="text-muted">Customer feedback</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Current Assignments -->
    <div class="col-md-8">
        {% if current_assignments %}
        <div class="section-card">
            <div class="section-header bg-warning text-white">
                <i class="fas fa-motorcycle me-2"></i>Active Assignments
            </div>
            <div class="section-body">
                {% for assignment in current_assignments %}
                <div class="list-item border p-3 mb-3 rounded">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="stat-icon" style="width: 50px; height: 50px; font-size: 1.2rem; background: var(--dashboard-warning);">
                                <i class="fas fa-box"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-bold">Order #{{ assignment.order.order_number|default:assignment.order.id }}</div>
                                    <div class="text-muted small">
                                        {{ assignment.order.user.get_full_name|default:assignment.order.user.username }}
                                    </div>
                                    <div class="text-muted small">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        {{ assignment.delivery_address.address_line_1 }}, {{ assignment.delivery_address.city }}
                                    </div>
                                    {% if assignment.pickup_address %}
                                    <div class="text-muted small">
                                        <i class="fas fa-store me-1"></i>
                                        Pickup: {{ assignment.pickup_address.address_line_1 }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-{% if assignment.status == 'assigned' %}warning{% elif assignment.status == 'picked_up' %}info{% else %}success{% endif %} mb-2">
                                        {{ assignment.get_status_display }}
                                    </span>
                                    <div class="fw-bold text-success">₹{{ assignment.order.total_amount }}</div>
                                    {% if assignment.estimated_distance_km %}
                                    <div class="text-muted small">{{ assignment.estimated_distance_km }} km</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="btn-group" role="group">
                                    {% if assignment.status == 'assigned' %}
                                        <a href="{% url 'delivery:accept_order' assignment.id %}" class="btn btn-success btn-sm">
                                            <i class="fas fa-check me-1"></i>Accept
                                        </a>
                                    {% elif assignment.status == 'accepted' %}
                                        <a href="{% url 'delivery:pickup_order' assignment.id %}" class="btn btn-primary btn-sm">
                                            <i class="fas fa-box me-1"></i>Mark Picked Up
                                        </a>
                                    {% elif assignment.status == 'picked_up' %}
                                        <a href="{% url 'delivery:deliver_order' assignment.id %}" class="btn btn-success btn-sm">
                                            <i class="fas fa-check-circle me-1"></i>Mark Delivered
                                        </a>
                                    {% endif %}
                                    <a href="{% url 'delivery:assignment_detail' assignment.id %}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-info me-1"></i>Details
                                    </a>
                                    <a href="tel:{{ assignment.order.user.phone_number }}" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-phone me-1"></i>Call
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Recent Deliveries -->
        <div class="section-card">
            <div class="section-header">
                <i class="fas fa-history me-2"></i>Recent Deliveries
            </div>
            <div class="section-body">
                {% if recent_deliveries %}
                    {% for delivery in recent_deliveries %}
                    <div class="list-item">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="stat-icon" style="width: 40px; height: 40px; font-size: 1rem; background: var(--dashboard-success);">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            <div>
                                <div class="fw-bold">
                                    Order #{{ delivery.order.order_number|default:delivery.order.id }}
                                </div>
                                <div class="text-muted small">
                                    Delivered {{ delivery.delivered_at|timesince }} ago
                                </div>
                                <div class="text-muted small">
                                    {{ delivery.order.user.get_full_name|default:delivery.order.user.username }}
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold text-success">₹{{ delivery.order.total_amount }}</div>
                            <div class="text-muted small">
                                {% if delivery.estimated_distance_km %}{{ delivery.estimated_distance_km }} km{% endif %}
                            </div>
                            {% if delivery.rating %}
                            <div class="text-warning small">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= delivery.rating %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'delivery:delivery_history' %}" class="btn btn-primary">
                            View All Deliveries
                        </a>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-motorcycle fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No deliveries yet</h5>
                        <p class="text-muted">Your completed deliveries will appear here</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Agent Profile & Quick Actions -->
    <div class="col-md-4">
        <div class="section-card">
            <div class="section-header">
                <i class="fas fa-user me-2"></i>Agent Profile
            </div>
            <div class="section-body">
                <div class="text-center mb-3">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" alt="{{ user.get_full_name }}" class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover;">
                    {% else %}
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                            <i class="fas fa-user fa-2x text-muted"></i>
                        </div>
                    {% endif %}
                </div>
                
                <h5 class="text-center mb-3">{{ user.get_full_name|default:user.username }}</h5>
                
                <div class="list-item">
                    <span>Agent ID</span>
                    <span class="fw-bold">{{ agent.agent_code|default:"N/A" }}</span>
                </div>
                
                <div class="list-item">
                    <span>Vehicle</span>
                    <span class="fw-bold">{{ user.profile.vehicle_type|default:"Not Set" }}</span>
                </div>
                
                <div class="list-item">
                    <span>Phone</span>
                    <span class="fw-bold">{{ user.phone_number|default:"Not Set" }}</span>
                </div>
                
                <div class="list-item">
                    <span>Rating</span>
                    <span class="fw-bold text-warning">
                        {{ agent.rating|default:"No ratings yet" }}
                        {% if agent.rating %}⭐{% endif %}
                    </span>
                </div>
                
                <div class="mt-3">
                    <a href="{% url 'accounts:profile' %}" class="btn btn-outline-primary w-100 mb-2">
                        <i class="fas fa-edit me-1"></i>Edit Profile
                    </a>
                    <a href="{% url 'delivery:vehicle_info' %}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-motorcycle me-1"></i>Vehicle Info
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="section-card">
            <div class="section-header">
                <i class="fas fa-bolt me-2"></i>Quick Actions
            </div>
            <div class="section-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'delivery:earnings' %}" class="btn btn-success btn-sm">
                        <i class="fas fa-rupee-sign me-2"></i>View Earnings
                    </a>
                    <a href="{% url 'delivery:delivery_history' %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-history me-2"></i>Delivery History
                    </a>
                    <a href="{% url 'delivery:ratings_feedback' %}" class="btn btn-warning btn-sm">
                        <i class="fas fa-star me-2"></i>Ratings & Reviews
                    </a>
                    <a href="{% url 'core:contact' %}" class="btn btn-info btn-sm">
                        <i class="fas fa-headset me-2"></i>Support
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- No Agent Profile Found -->
<div class="row">
    <div class="col-12">
        <div class="section-card">
            <div class="section-body text-center py-5">
                <i class="fas fa-motorcycle fa-4x text-muted mb-4"></i>
                <h3 class="text-muted">Agent Profile Not Found</h3>
                <p class="text-muted mb-4">
                    Your delivery agent profile needs to be set up or approved by the admin.
                </p>
                <a href="{% url 'core:contact' %}" class="btn btn-primary">
                    Contact Support
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Toggle availability status
document.getElementById('toggle-availability').addEventListener('click', function() {
    const button = this;
    const isCurrentlyAvailable = button.classList.contains('btn-danger');
    
    fetch('/delivery/toggle-availability/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            available: !isCurrentlyAvailable
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update button
            if (data.available) {
                button.className = 'btn btn-danger';
                button.innerHTML = '<i class="fas fa-power-off me-1"></i>Go Offline';
            } else {
                button.className = 'btn btn-success';
                button.innerHTML = '<i class="fas fa-power-off me-1"></i>Go Online';
            }
            
            // Reload page to update status
            setTimeout(() => window.location.reload(), 1000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
});

// Auto refresh current assignments every 2 minutes
{% if current_assignments %}
setTimeout(function() {
    window.location.reload();
}, 120000);
{% endif %}
</script>
{% endblock %}
